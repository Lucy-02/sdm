generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Auth (Better Auth)
// ============================================

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  name          String?
  image         String?   // Better Auth 프로필 이미지
  phone         String?
  role          String    @default("CUSTOMER")  // "CUSTOMER" | "VENDOR" | "ADMIN"

  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Favorite: 찜한 업체 ID 배열
  favoriteVendorIds String[] @db.ObjectId

  // Better Auth Relations
  sessions      Session[]
  accounts      Account[]

  // Business Relations
  simulationResults SimulationResult[]
  ownedVendors      Vendor[]           @relation("VendorOwner")
  reviews           Review[]
  bookings          Booking[]
}

model Session {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  token         String    @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
}

model Account {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  userId                String    @db.ObjectId
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  accountId             String    // OAuth provider user ID
  providerId            String    // "google", "kakao", "naver", "credential"

  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?   // 이메일/비밀번호 인증용 (해싱됨)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  identifier  String    // 이메일 주소
  value       String    // 인증 토큰
  expiresAt   DateTime

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([identifier])
}

// ============================================
// Simulation (AI 결혼 사진)
// ============================================

model SimulationResult {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 입력 이미지
  groomImageUrl   String
  brideImageUrl   String

  // 출력 이미지
  outputImageUrl  String?

  // 처리 상태
  status          String    @default("PENDING")  // "PENDING" | "UPLOADING" | "PROCESSING" | "COMPLETED" | "FAILED"
  concept         String?   // "classic", "modern", "outdoor", "vintage"

  // 메타데이터 (처리 시간, AI 모델 버전 등)
  metadata        Json?     // { processingTime: 45000, modelVersion: "v2.1", ... }

  // 에러 정보
  errorMessage    String?

  createdAt       DateTime  @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Vendor Categories (확장 가능)
// ============================================

model VendorCategory {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  slug            String    @unique       // "studio", "makeup", "dress", "venue", "car"
  name            String                  // "스튜디오", "메이크업"
  description     String?
  icon            String?                 // 아이콘 URL 또는 emoji

  displayOrder    Int       @default(0)   // 표시 순서
  isActive        Boolean   @default(true)

  // 메타데이터 스키마 정의
  schemaVersion   String    @default("1.0")
  requiredFields  Json?     // { "portfolio": true, "certifications": false, ... }

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  vendors         Vendor[]
  tags            Tag[]

  @@index([isActive, displayOrder])
}

// ============================================
// Tags (검색 및 필터링)
// ============================================

model Tag {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String                              // "야외촬영", "한복", "채플"
  slug          String    @unique                   // "outdoor", "hanbok", "chapel"

  categoryId    String?   @db.ObjectId              // 특정 카테고리에 속한 태그
  category      VendorCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  usageCount    Int       @default(0)               // 사용된 횟수

  createdAt     DateTime  @default(now())

  @@index([categoryId])
}

// ============================================
// Vendors (업체)
// ============================================

model Vendor {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId

  // 카테고리
  categoryId      String          @db.ObjectId
  category        VendorCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // 소유자
  ownerId         String?         @db.ObjectId
  owner           User?           @relation("VendorOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // 기본 정보
  name            String
  slug            String          @unique       // URL용 (unique)
  description     String?

  // 연락처
  phone           String?
  email           String?
  website         String?

  // 위치
  location        String                        // "서울특별시 강남구 테헤란로 123"
  lat             Float?                        // 위도
  lng             Float?                        // 경도

  // 가격
  priceRange      String?                       // "100만원~200만원" (표시용)
  priceMin        Int?                          // 100 (필터링용, 단위: 만원)
  priceMax        Int?                          // 200

  // 영업 정보
  businessHours   Json?           // { "mon": "09:00-18:00", "tue": "09:00-18:00", ... }

  // 태그: 임베디드 방식 (검색 효율 위해)
  tags            Json?           // [{ id, name, slug }, ...]

  // 이미지: 임베디드 방식
  images          Json?           // [{ url, type, displayOrder, altText }, ...]

  // 업체별 고유 속성 (확장 가능)
  metadata        Json?           // 예시:
                                  // 스튜디오: { "studioSize": "200평", "equipments": ["4K카메라", ...] }
                                  // 메이크업: { "certifications": ["국가자격증"], "specialties": ["한복"] }
                                  // 예식장: { "capacity": 300, "parkingSpots": 100, "hasChapel": true }

  // 통계
  rating          Float           @default(0)   // 평균 평점 (1-5)
  reviewCount     Int             @default(0)
  bookingCount    Int             @default(0)
  favoriteCount   Int             @default(0)
  viewCount       Int             @default(0)

  // 상태
  isVerified      Boolean         @default(false)  // 인증 업체
  isActive        Boolean         @default(true)
  isPremium       Boolean         @default(false)  // 프리미엄 업체 (광고)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations (1:N은 유지)
  reviews         Review[]
  bookings        Booking[]

  @@index([categoryId])
  @@index([isActive, isPremium])
  @@index([rating])
  @@index([location])
  @@index([priceMin, priceMax])
}

// ============================================
// Reviews
// ============================================

model Review {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  vendorId      String    @db.ObjectId
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookingId     String?   @db.ObjectId
  booking       Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  rating        Int                 // 1-5
  title         String?
  content       String
  images        Json?               // ["url1", "url2", ...]

  isVerified    Boolean   @default(false)  // 실제 이용 확인

  // 업체 답변
  response      String?
  respondedAt   DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([vendorId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

// ============================================
// Bookings (예약/문의)
// ============================================

model Booking {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  vendorId        String    @db.ObjectId
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  status          String    @default("PENDING")  // "PENDING" | "CONFIRMED" | "COMPLETED" | "CANCELLED" | "REJECTED"

  // 결혼식 정보
  eventDate       DateTime?               // 결혼식 날짜
  guestCount      Int?                    // 하객 수 (예식장용)
  budget          Int?                    // 예산 (만원)

  // 문의 내용
  message         String
  vendorResponse  String?

  // 업체별 추가 정보 (확장 가능)
  metadata        Json?         // 예시:
                                // 스튜디오: { "shootingDate": "2025-05-01", "location": "야외" }
                                // 예식장: { "meal": "한식", "ceremony": "양식" }

  createdAt       DateTime      @default(now())
  confirmedAt     DateTime?
  completedAt     DateTime?

  // Relations
  reviews         Review[]

  @@index([vendorId])
  @@index([userId])
  @@index([status])
  @@index([eventDate])
}

// ============================================
// Vendor Invite (업체 초대 링크)
// ============================================

model VendorInvite {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  token       String    @unique                 // 초대 토큰 (UUID 또는 랜덤 문자열)
  email       String?                           // 특정 이메일 지정 (선택)
  categoryId  String?   @db.ObjectId            // 카테고리 사전 지정 (선택)

  expiresAt   DateTime                          // 만료 시간
  usedAt      DateTime?                         // 사용 시간
  usedBy      String?   @db.ObjectId            // 사용한 사용자 ID

  createdBy   String    @db.ObjectId            // 생성한 관리자 ID
  createdAt   DateTime  @default(now())

  @@index([expiresAt])
}
