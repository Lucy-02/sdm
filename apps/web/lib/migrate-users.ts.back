/**
 * MongoDB ì»¬ë ‰ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
 *
 * 'user' (ì†Œë¬¸ì) ì»¬ë ‰ì…˜ì˜ ë°ì´í„°ë¥¼ 'User' (ëŒ€ë¬¸ì) ì»¬ë ‰ì…˜ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.
 * ë˜í•œ 'session' -> 'Session', 'account' -> 'Account' ì»¬ë ‰ì…˜ë„ ë§ˆì´ê·¸ë ˆì´ì…˜í•©ë‹ˆë‹¤.
 *
 * ì‹¤í–‰ ë°©ë²•:
 * npx tsx apps/web/lib/migrate-users.ts
 */

import { MongoClient } from "mongodb";

const DATABASE_URL = process.env.DATABASE_URL || "mongodb://localhost:27017/sdm";

interface MigrationResult {
  collection: string;
  migrated: number;
  skipped: number;
  errors: string[];
}

async function migrateCollection(
  db: ReturnType<MongoClient["db"]>,
  sourceCollection: string,
  targetCollection: string
): Promise<MigrationResult> {
  const result: MigrationResult = {
    collection: `${sourceCollection} -> ${targetCollection}`,
    migrated: 0,
    skipped: 0,
    errors: [],
  };

  // ì†ŒìŠ¤ ì»¬ë ‰ì…˜ ì¡´ì¬ í™•ì¸
  const collections = await db.listCollections({ name: sourceCollection }).toArray();
  if (collections.length === 0) {
    console.log(`  â­ï¸  '${sourceCollection}' ì»¬ë ‰ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ê±´ë„ˆëœ€`);
    return result;
  }

  const source = db.collection(sourceCollection);
  const target = db.collection(targetCollection);

  // ì†ŒìŠ¤ ì»¬ë ‰ì…˜ì˜ ëª¨ë“  ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
  const documents = await source.find({}).toArray();
  console.log(`  ğŸ“Š '${sourceCollection}'ì—ì„œ ${documents.length}ê°œ ë¬¸ì„œ ë°œê²¬`);

  for (const doc of documents) {
    try {
      // íƒ€ê²Ÿì— ë™ì¼í•œ _idê°€ ìˆëŠ”ì§€ í™•ì¸
      const existing = await target.findOne({ _id: doc._id });

      if (existing) {
        console.log(`    â­ï¸  ID ${doc._id} ì´ë¯¸ ì¡´ì¬ - ê±´ë„ˆëœ€`);
        result.skipped++;
        continue;
      }

      // íƒ€ê²Ÿ ì»¬ë ‰ì…˜ì— ì‚½ì…
      await target.insertOne(doc);
      console.log(`    âœ… ID ${doc._id} ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ`);
      result.migrated++;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.log(`    âŒ ID ${doc._id} ì—ëŸ¬: ${errorMessage}`);
      result.errors.push(`${doc._id}: ${errorMessage}`);
    }
  }

  return result;
}

async function main() {
  console.log("ğŸš€ MongoDB ì»¬ë ‰ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘\n");
  console.log(`ğŸ“ ë°ì´í„°ë² ì´ìŠ¤: ${DATABASE_URL}\n`);

  const client = new MongoClient(DATABASE_URL);

  try {
    await client.connect();
    console.log("âœ… MongoDB ì—°ê²° ì„±ê³µ\n");

    const db = client.db();

    // ë§ˆì´ê·¸ë ˆì´ì…˜í•  ì»¬ë ‰ì…˜ ëª©ë¡ (ì†Œë¬¸ì -> ëŒ€ë¬¸ì)
    const migrations = [
      { source: "user", target: "User" },
      { source: "session", target: "Session" },
      { source: "account", target: "Account" },
      { source: "verification", target: "Verification" },
    ];

    const results: MigrationResult[] = [];

    for (const { source, target } of migrations) {
      console.log(`\nğŸ“¦ ${source} -> ${target} ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...`);
      const result = await migrateCollection(db, source, target);
      results.push(result);
    }

    // ê²°ê³¼ ìš”ì•½
    console.log("\n" + "=".repeat(50));
    console.log("ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ ìš”ì•½\n");

    for (const result of results) {
      console.log(`${result.collection}:`);
      console.log(`  - ë§ˆì´ê·¸ë ˆì´ì…˜ë¨: ${result.migrated}`);
      console.log(`  - ê±´ë„ˆëœ€ (ì´ë¯¸ ì¡´ì¬): ${result.skipped}`);
      if (result.errors.length > 0) {
        console.log(`  - ì—ëŸ¬: ${result.errors.length}`);
      }
    }

    // ì†ŒìŠ¤ ì»¬ë ‰ì…˜ ì‚­ì œ ì—¬ë¶€ í™•ì¸ ë©”ì‹œì§€
    console.log("\n" + "=".repeat(50));
    console.log("âš ï¸  ì£¼ì˜: ì†ŒìŠ¤ ì»¬ë ‰ì…˜(user, session, account, verification)ì€ ì‚­ì œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    console.log("    ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ì„¸ìš”:");
    console.log("    MongoDB Shellì—ì„œ:");
    console.log("      db.user.drop()");
    console.log("      db.session.drop()");
    console.log("      db.account.drop()");
    console.log("      db.verification.drop()");

  } catch (error) {
    console.error("âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:", error);
    process.exit(1);
  } finally {
    await client.close();
    console.log("\nâœ… MongoDB ì—°ê²° ì¢…ë£Œ");
  }
}

main();
